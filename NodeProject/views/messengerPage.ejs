<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Socket.IO chat</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="/css/sample.css">
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans&display=swap" rel="stylesheet">
    </head>
    <body oncontextmenu="return false">
        <div class="row customize-row">
            <div class="col-md-4 sub">
                <ul id="list"></ul>
            </div>
            <div class="col-md-8 main">
                <nav class="box-chat">
                        <span class="info-box-chat">
                            <span class="user-name">Title box chat</span>
                            <span class="count-member">number of member</span>
                        </span>
                        <span class="config-box-chat"><i class="fa fa-cog"></i></span>
                </nav>
                <div class="list-member">
                    <span class="list-member-info">
                        <span class="mini-member-info"><img src="/docs/upload/2019-11-29T10-16-45.708Z45408661864_922eed5824_o.jpg"> <span>synztran</span>,</span>
                        <span class="mini-member-info"><img src="/docs/upload/2019-11-29T10-16-45.708Z45408661864_922eed5824_o.jpg"> <span>synztran</span>,</span>
                        <span class="mini-member-info"><img src="/docs/upload/2019-11-29T10-16-45.708Z45408661864_922eed5824_o.jpg"> <span>synztran</span>,</span>
                        <span class="mini-member-info"><img src="/docs/upload/2019-11-29T10-16-45.708Z45408661864_922eed5824_o.jpg"> <span>synztran</span>,</span>
                        <span class="mini-member-info"><img src="/docs/upload/2019-11-29T10-16-45.708Z45408661864_922eed5824_o.jpg"> <span>synztran</span></span>
                      
                    </span>
                    <span class="sample-text">This is the start of a beautiful thing. Say something nice, or share a cat fact.</span>
                </div>
                <ul id="messages"></ul> 
                <ul id="catch-user"></ul>
                <ul id="typing-state"></ul>
                <form action="">
                    <input id="m" autocomplete="off" placeholder="Type something" /><button>Send</button>
                </form>
            </div>
        </div>
    </body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    
    <script>
        $(function(){
            
            var socket = io();
            var time = (new Date());
            var a = time.toString();
            var h = (time.getHours() < 10 ? '0' : '') + time.getHours();
            var m = (time.getMinutes() < 10 ? '0' : '') +  time.getMinutes();
            var s = (time.getSeconds() < 10 ? '0' : '') + time.getSeconds();
            console.log(a)
            console.log(h)
            console.log(m)
            console.log(s)
            var curtime = h + ":" + m
            var b = (curtime.toString()).match(/^([01]\d|2[0-3])(:)([0-5]\d)(:[0-5]\d)?$/);
            if (b.length > 1) { // If time format correct
                b = b.slice(1); // Remove full string match value
                b[5] = +b[0] < 12 ? ' AM ' : ' PM '; // Set AM/PM
                b[0] = +b[0] % 12 || 12; // Adjust hours
            }
            var cvtime = b.join('');
            
            $("#messages").stop().animate({ scrollTop: $("#messages")[0].scrollHeight}, 1000);
            $('form').submit(function(e){
                e.preventDefault();
                if($('#m').val() == ''){
                    
                }else{
                    socket.emit('chat message', $('#m').val());
                    $("#messages").stop().animate({ scrollTop: $("#messages")[0].scrollHeight}, 1000);
                }
                $('#m').val('');
                return false;
            });

            socket.on('chat message', function(msg, username, id){
                    var  still = false
                    console.log(socket.io.engine.id)
                    console.log(id);console.log(username);
                    if(socket.io.engine.id = id && still == false){
                        document.getElementById('messages').innerHTML += 
                        '<div class="message-container"><li class="message-info"><span class="message-user-avt"><img src="/docs/upload/2019-11-29T10-16-45.708Z45408661864_922eed5824_o.jpg"/></span><span class="message-user-name"><strong>' + username +'</strong></span><span class="message-time">' + cvtime +'</span></li><li class="message-content">' + msg + '</li></div>';
                        still = true
                    }else{
                        document.getElementById('messages').innerHTML += '<li class="message-content"><strong>'+ username +'</strong>'+  '&nbsp;'+ cvtime + ' : ' + msg + '</li>'
                        still = false
                    }

                    

                    


                    $("#messages").stop().animate({ scrollTop: $("#messages")[0].scrollHeight}, 1000);
                 
                    window.scrollTo(0, document.body.scrollHeight);
            });

            socket.on('news', function(data){
                console.log(data);
                // $('#catch-user').append($('<li>')).text(data['hello'] + ' joined');
                document.getElementById('catch-user').innerHTML += '<li class="catch-user-content"><strong>'+ data['name'] + ' joined' +'</strong></li>'
                    window.scrollTo(0, document.body.scrollHeight);
                setTimeout(() => {
                    $('#catch-user').hide();
                }, 3000);
            });

            // socket.on('connect', ()=>{
            //     console.log(socket.id, socket.io.engine.id, socket.json.id)
            
            // })
            // socket.on('disconnect', function(data){
            //     // document.getElementById('typing-state').innerHTML += '<li><strong>'+ data['hello'] + ' joined' +'</strong></li>'
            //     // console.log(data);
            //      document.getElementById('typing-state').innerHTML += '<li><strong>'+ data+'</strong></li>'
            //     setTimeout(() => {
            //         $('#typing-state').hide();
            //     }, 4000);
            // })
            
            socket.on('load user name',function(data){
                io.emit('load user name', data);
                console.log(data);
                $('#catch-user').append($('<li>')).text(data);
                    // window.scrollTo(0, document.body.scrollHeight);
            });

            var timeout;
            function timeoutFunc(){
                socket.emit("typing", false);
            }

            socket.on('typing', function(data, username){
                console.log({data, username});
                if(data){
                    document.getElementById('typing-state').innerHTML = '<p><em>' + username + ' is typing...</em></p>'
                }else{
                    document.getElementById('typing-state').innerHTML = ''
                }
            });

            document.getElementById('m').addEventListener('keyup',function(){
                socket.emit('typing', 'aaaa');
                clearTimeout(timeout)
                timeout = setTimeout(timeoutFunc, 250)
            })

            socket.on('count', function(data, online){
                console.log(data);
                console.log(online);
                document.getElementById('list').innerHTML = '<li><strong>'+ data+ online +'</strong></li>'
            })
            

        });
    </script>
</html>